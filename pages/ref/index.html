<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî StarsBox</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100%; overflow-x:hidden }

    /* ===== –¢–ï–ú–ê ===== */
    .ref-page{
      --form-w: clamp(320px, 92vw, 520px);

      --bg:#090d18; --text:#e6e9f0; --muted:#9aa0a6;
      --card:#0b0e1b; --card-brd:rgba(255,255,255,.12);

      --btn-bg:rgba(255,255,255,.06);
      --btn-brd:rgba(255,255,255,.18);
      --btn-hover:rgba(255,255,255,.10);
      --btn-active:rgba(82,102,255,.18);
      --focus:#5266ff;

      --block-gap:16px;
    }

    /* ===== –ë–ê–ó–ê + –§–û–ù ===== */
    body.ref-page{
      margin:0; color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg); min-height:100%; position:relative;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    body.ref-page::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(60% 100% at 50% 0%, #0e1530 0%, var(--bg) 70%);
      background-repeat:no-repeat; background-size:cover; pointer-events:none;
    }

    /* ===== –¢–û–ü–ë–ê–† ===== */
    .topbar{
      position:sticky; top:0; display:grid; grid-template-columns:44px 1fr 44px;
      align-items:center; gap:8px; padding:14px calc((100vw - var(--form-w))/2) 14px;
      background:rgba(9,13,24,.7); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--card-brd); z-index:10;
    }
    .title{ margin:0; text-align:center; font-size:18px; font-weight:400 }
    .topbar-spacer{ width:44px; height:40px }
    .back-btn{
      justify-self:start; width:40px; height:40px; border:1px solid var(--btn-brd);
      background:var(--btn-bg); border-radius:14px; display:inline-grid; place-items:center;
      cursor:pointer; text-decoration:none; transition:background .2s, border-color .2s, transform .06s;
    }
    .back-btn::before{
      content:""; width:10px; height:10px; border-left:2px solid var(--text); border-bottom:2px solid var(--text);
      transform:translateX(1px) rotate(45deg);
    }
    .back-btn:hover{ background:var(--btn-hover) }
    .back-btn:active{ transform:translateY(1px) }
    .back-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px }

    /* ===== –ö–û–õ–û–ù–ö–ê –ö–û–ù–¢–ï–ù–¢–ê ===== */
    .wrap{ width:100%; max-width:var(--form-w); margin:20px auto 40px; padding:0 6px 20px }
    .wrap>*+*{ margin-top:var(--block-gap) }

    /* ===== –ö–ê–†–¢–û–ß–ö–ò ===== */
    .group-card{
      border-radius:14px; padding:14px; border:1px solid var(--card-brd);
      background:rgba(255,255,255,.06); box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    .muted{ color:var(--muted) }
    .sec-title{ margin:0 0 8px; font-size:14px; font-weight:400 }

    /* ===== –ö–ù–û–ü–ö–ò/–ò–ù–ü–£–¢–´ ===== */
    .btn{
      min-height:40px; width:100%; border-radius:14px; border:1px solid var(--btn-brd);
      background:var(--btn-bg); color:var(--text); cursor:pointer;
      display:inline-grid; place-items:center; transition:background .2s, border-color .2s, transform .06s, box-shadow .2s, opacity .2s;
      user-select:none;
    }
    .btn:hover{ background:var(--btn-hover) } .btn:active{ transform:translateY(1px) }
    .btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px }
    .btn--primary{ background:var(--btn-active); border-color:rgba(82,102,255,.4); box-shadow:0 0 0 2px rgba(82,102,255,.18) inset }
    .btn--sm{ min-height:34px; width:auto; padding:0 12px }

    .inp{
      width:100%; height:40px; border-radius:14px; border:1px solid var(--btn-brd);
      background:var(--btn-bg); color:var(--text); padding:0 12px; font-size:14px;
    }

    /* ===== –¢–ï–ö–°–¢–û–í–ê–Ø –ö–ù–û–ü–ö–ê-–°–°–´–õ–ö–ê ===== */
    .link-btn{
      background:transparent; border:0; color:#9fb2ff;
      font-size:13px; padding:0 2px; cursor:pointer; border-radius:8px; transition:background .2s;
    }
    .link-btn:hover{ background:rgba(255,255,255,.06) }
    .link-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px }

    /* ===== –ë–ê–õ–ê–ù–° + –ö–ù–û–ü–ö–ê –í–´–í–û–î–ê ===== */
    .balance{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px }
    .balance__val{ font-size:22px; line-height:1.2 }

    /* ===== –†–ï–§-–°–°–´–õ–ö–ê ===== */
    .ref-field{ display:grid; gap:8px }
    .ref-actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px }

    /* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê/–°–¢–ê–í–ö–ò –ö–ê–†–¢–û–ß–ö–ò ===== */
    .stats-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .stat-card{
      border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(120% 140% at 10% 120%, rgba(82,148,255,.16) 0%, transparent 65%),
                  linear-gradient(180deg, #0f1630 0%, #0b1226 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), inset 0 -1px 0 rgba(255,255,255,.03), 0 8px 28px rgba(0,0,0,.42);
    }
    .stat-title{ margin:0 0 6px; font-size:12px; color:var(--muted) }
    .stat-value{ margin:0; font-size:18px }

    /* ===== –¢–ê–ë–õ–ò–¶–´ ===== */
    .table{ width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed }
    .table th,.table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; vertical-align:top; word-break:break-word }
    .table th{ color:var(--muted); font-weight:500 }

    /* ===== –ú–û–î–ê–õ–ö–ò ===== */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:50 }
    .modal.is-open{ display:grid }
    .modal__card{
      position: relative;           /* –≤–∞–∂–Ω–æ –¥–ª—è –∫—Ä–µ—Å—Ç–∏–∫–∞ */
      width:min(520px, 92vw); border-radius:16px; padding:16px; background:rgba(15,22,40,.98);
      border:1px solid rgba(255,255,255,.12); box-shadow:0 12px 40px rgba(0,0,0,.45);
      max-height: 90vh; overflow:auto;
    }
    .modal__title{ margin:0 0 10px; font-size:16px; font-weight:500 }
    .form{ display:grid; gap:10px }
    .field{ display:grid; gap:6px }
    .field label{ font-size:13px; color:var(--muted) }
    .row-2{ display:grid; grid-template-columns:1fr auto; gap:8px }
    .err{ margin:0; font-size:12px; color:#ffffff; min-height:1.1em }
    .modal__actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px }
    .close-x{ position:absolute; right:12px; top:12px; width:28px; height:28px; border-radius:10px; border:1px solid var(--btn-brd); background:var(--btn-bg) }
    .close-x:before,.close-x:after{ content:""; position:absolute; left:50%; top:50%; width:12px; height:2px; background:#fff; transform-origin:center }
    .close-x:before{ transform:translate(-50%,-50%) rotate(45deg) } .close-x:after{ transform:translate(-50%,-50%) rotate(-45deg) }

    /* ===== –ü–û–î–°–ö–ê–ó–ö–ò / –ò–ù–§–û-–ü–ê–ù–ï–õ–ò ===== */
.note-card{
  border-radius: 14px;
  padding: 10px;
  border: 1px solid rgba(255,255,255,.18);
  margin-top: 0px;
}

.note-card--light{
  background: rgba(255,255,255,.10);          /* –±–µ–ª–∞—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
  border-color: rgba(255,255,255,.30);
}

.note-card--gold{
  background: rgba(210, 160, 30, .18);        /* –∑–æ–ª–æ—Ç–∏—Å—Ç–∞—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è */
  border-color: rgba(255, 210, 100, .45);
  color: #ffe9b0;                              /* —Ç—ë–ø–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ç—ë–º–Ω–æ–º —Ñ–æ–Ω–µ */
}

.note-card__text{
  margin: 0;
  font-size: 10px;
  line-height: 1.1;
  color: inherit; /* –Ω–∞—Å–ª–µ–¥—É–µ–º —Ü–≤–µ—Ç (–¥–ª—è gold ‚Äî —Ç—ë–ø–ª—ã–π, –¥–ª—è light ‚Äî –æ–±—ã—á–Ω—ã–π) */
}

    /* –Ω–∏–∂–Ω–∏–π ¬´–≤–æ–∑–¥—É—Ö¬ª */
    .ref-page{ --bottom-space: clamp(24px, 6vh, 64px) }
    @supports(padding: env(safe-area-inset-bottom)){
      .ref-page{ --bottom-space: calc(32px + env(safe-area-inset-bottom)) }
    }
    .wrap::after{ content:""; display:block; height:var(--bottom-space) }
  </style>
</head>
<body class="ref-page">
  <!-- ===== –¢–æ–ø–±–∞—Ä ===== -->
  <header class="topbar">
    <a class="back-btn" href="../../index.html" aria-label="–ù–∞–∑–∞–¥"></a>
    <h1 class="title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h1>
    <div class="topbar-spacer" aria-hidden="true"></div>
  </header>

  <!-- ===== –ö–æ–Ω—Ç–µ–Ω—Ç ===== -->
  <main class="wrap">
    <!-- –ë–∞–ª–∞–Ω—Å -->
    <section class="group-card">
      <h2 class="sec-title muted">–ë–∞–ª–∞–Ω—Å</h2>
      <div class="balance">
        <div id="balanceValue" class="balance__val">0 ‚ÇΩ</div>
        <button id="withdrawOpen" class="btn btn--primary btn--sm">–í—ã–≤–µ—Å—Ç–∏</button>
      </div>
    </section>

    <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->
    <section class="group-card">
      <h2 class="sec-title muted">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h2>
      <div class="ref-field">
        <input class="inp" id="refLink" readonly value="‚Äî" />
        <div class="ref-actions">
          <button class="btn" id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn btn--primary" id="shareBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    </section>

    <!-- –ò–ù–§–û-–ü–ê–ù–ï–õ–¨ -->
    <section class="group-card">
      <h2 class="sec-title muted" style="margin-bottom:6px">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</h2>
      <p class="muted" style="margin:0 0 8px">
        <button class="link-btn" id="ratesOpen" type="button">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É —Å–µ—Ä–≤–∏—Å–∞</button>
      </p>
    </section>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section class="group-card">
      <h2 class="sec-title muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="stats-grid">
        <div class="stat-card"><p class="stat-title">–†–µ—Ñ–µ—Ä–∞–ª—ã</p><p class="stat-value" id="st_total">0</p></div>
        <div class="stat-card"><p class="stat-title">–°–æ–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–æ–∫—É–ø–∫—É</p><p class="stat-value" id="st_active">0</p></div>
        <div class="stat-card"><p class="stat-title">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</p><p class="stat-value" id="st_earned">0</p></div>
        <div class="stat-card"><p class="stat-title">–°—Ä–µ–¥–Ω–∏–π –±–æ–Ω—É—Å</p><p class="stat-value" id="st_avg">0</p></div>
      </div>
    </section>

    <!-- –í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã -->
    <section class="group-card">
      <h2 class="sec-title muted">–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h2>
      <table class="table" id="refsTable">
        <thead><tr><th>–†–µ—Ñ–µ—Ä–∞–ª</th><th>–ü–æ–∫—É–ø–æ–∫</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th></tr></thead>
        <tbody id="refsBody"></tbody>
      </table>
    </section>

    <!-- –ù–∞—á–∏—Å–ª–µ–Ω–∏—è -->
    <section class="group-card">
      <h2 class="sec-title muted">–ù–∞—á–∏—Å–ª–µ–Ω–∏—è</h2>
      <table class="table" id="tbl">
        <thead><tr><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–ë–æ–Ω—É—Å</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–´–í–û–î–ê ===== -->
  <div class="modal" id="wdModal" aria-hidden="true">
    <div class="modal__card">
      <button class="close-x" id="wdClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      <h3 class="modal__title">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥</h3>

      <form class="form" id="wdForm" onsubmit="return false">
        <div class="field">
          <label for="wdAddr">TON-–∫–æ—à–µ–ª—ë–∫</label>
          <input id="wdAddr" class="inp" placeholder="UQ‚Ä¶ –∏–ª–∏ 0:‚Ä¶" inputmode="text" autocomplete="off" />
        </div>
        <div class="field">
          <label for="wdAmount">–°—É–º–º–∞ (‚ÇΩ)</label>
          <div class="row-2">
            <input id="wdAmount" class="inp" type="text" inputmode="decimal" placeholder="0,00" autocomplete="off" />
            <button type="button" class="btn" id="fillAll">–í–µ—Å—å –±–∞–ª–∞–Ω—Å</button>
          </div>
          <p class="err" id="wdErr"></p>
        </div>
        <div class="note-card note-card--gold">
          –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ 5&nbsp;000&nbsp;‚ÇΩ
        </div>
        <div class="modal__actions">
          <button type="button" class="btn" id="wdCancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn--primary" id="wdSend">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –° –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò –°–¢–ê–í–ö–ê–ú–ò ===== -->
  <div class="modal" id="ratesModal" aria-hidden="true">
    <div class="modal__card">
      <button class="close-x" id="ratesClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      <h3 class="modal__title">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞–≤–∫–∏</h3>

      <div class="stats-grid" id="ratesGrid">
        <!-- —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏–º 5 –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ % -->
      </div>

      <div class="note-card note-card--light">
        <p class="note-card__text">
          –í—Å–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞.
        </p>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const tg = window.Telegram?.WebApp; tg?.ready?.();

    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    const API_BASE = 'https://api.starsbox.org';
    const BOT_USERNAME = 'StarssBox_bot';
    const SUPPORT_USERNAME = 'Starsbox_support';

    // === –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –°–£–ú–ú–ê –í–´–í–û–î–ê ===
    const MIN_WITHDRAW_MINOR = 5000 * 100; // 5 000 ‚ÇΩ –≤ –∫–æ–ø–µ–π–∫–∞—Ö

    // ===== –£–¢–ò–õ–ò–¢–´ –î–ï–ù–ï–ì =====
    const nfRub = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'RUB', maximumFractionDigits:2 });
    const rubFmt = (minor) => nfRub.format((Number(minor||0)/100));
    const toMinor = (val) => {
      const n = Number(String(val).replace(',', '.').replace(/\s+/g,''));
      if (!isFinite(n) || n < 0) return null;
      return Math.round(n * 100);
    };
    const pctFmt = (v)=>{
      const n = Number(v);
      if (!isFinite(n)) return '‚Äî';
      const p = n <= 1 ? n*100 : n;
      return (p % 1 === 0 ? p.toFixed(0) : p.toFixed(2)) + '%';
    };

    // ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
    let MY_ID = tg?.initDataUnsafe?.user?.id || null;
    let MY_USERNAME = tg?.initDataUnsafe?.user?.username || '';
    let balanceMinor = 0;

    function resolveMyIdIfMissing(){
      if (MY_ID) return MY_ID;
      const q = new URLSearchParams(location.search);
      const v = q.get('uid'); if (v) MY_ID = parseInt(v,10);
      return MY_ID;
    }

    async function jget(url){
      const r = await fetch(url, { headers:{ 'Accept':'application/json' }});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    function setText(id, t){ const el = document.getElementById(id); if (el) el.textContent = t; }

    // ====== –ò–ù–ò–¢ ======
    async function init(){
      if (!resolveMyIdIfMissing()){
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –º–∏–Ω–∏-–∞–ø–ø–∞ Telegram, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Telegram ID.');
        return;
      }

      // –ë–∞–ª–∞–Ω—Å + —Ä–µ—Ñ.–∫–æ–¥
      try{
        const me = await jget(`${API_BASE}/ref/me?tg_user_id=${encodeURIComponent(MY_ID)}`);
        if (me?.ok){
          balanceMinor = Number(me.balance_minor||0);
          document.getElementById('balanceValue').textContent = rubFmt(balanceMinor);
          const refCode = me.ref_code || '';
          const deeplink = `https://t.me/${BOT_USERNAME}?startapp=${encodeURIComponent('ref:'+refCode)}`;
          document.getElementById('refLink').value = deeplink;
        }
      }catch(e){}

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      try{
        const st = await jget(`${API_BASE}/ref/stats?tg_user_id=${encodeURIComponent(MY_ID)}`);
        setText('st_total',  st.total_refs ?? '0');
        setText('st_active', st.active_refs ?? '0');
        setText('st_earned', rubFmt(st.total_bonus_minor ?? 0));
        setText('st_avg',    rubFmt(st.avg_bonus_minor ?? 0));
      }catch(e){}

      // –†–µ—Ñ–µ—Ä–∞–ª—ã
      try{
        const rr = await jget(`${API_BASE}/ref/referrals?tg_user_id=${encodeURIComponent(MY_ID)}&limit=200&offset=0`);
        const body = document.getElementById('refsBody'); body.innerHTML='';
        (rr.items||[]).forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.username ? '@'+it.username : it.tg_user_id}</td>
                          <td>${it.orders_count ?? 0}</td>
                          <td>${rubFmt(it.total_paid_minor ?? 0)}</td>`;
          body.appendChild(tr);
        });
        if ((rr.items||[]).length===0){
          const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="3" class="muted">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</td>`;
          body.appendChild(tr);
        }
      }catch(e){}

      // –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
      try{
        const lg = await jget(`${API_BASE}/ref/ledger?tg_user_id=${encodeURIComponent(MY_ID)}&limit=100&offset=0`);
        const tb = document.getElementById('tbody'); tb.innerHTML='';
        (lg.items||[]).forEach(it=>{
          const tr = document.createElement('tr');
          const dt = new Date(it.created_at);
          tr.innerHTML = `<td class="muted">${dt.toLocaleString('ru-RU')}</td>
                          <td>${rubFmt(it.amount_minor)}</td>
                          <td><b>${rubFmt(it.bonus_minor)}</b></td>`;
          tb.appendChild(tr);
        });
        if ((lg.items||[]).length===0){
          const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="3" class="muted">–ù–∞—á–∏—Å–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</td>`;
          tb.appendChild(tr);
        }
      }catch(e){}
    }

    // ====== –†–ï–§-–°–°–´–õ–ö–ê (–∫–æ–ø–∏—Ä/—à–∞—Ä–∏–Ω–≥) ======
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const v = document.getElementById('refLink').value || '';
      try{ await navigator.clipboard.writeText(v); tg?.showToast?.('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }
      catch{ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é'); }
    });
    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      const url = document.getElementById('refLink').value || '';
      if (!url) return;
      if (navigator.share){ try{ await navigator.share({ title:'StarsBox', text:'–ú–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∏–Ω–≤–∞–π—Ç –≤ StarsBox', url }); return; }catch{} }
      const webLink = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è üëá')}`;
      if (tg?.openTelegramLink) tg.openTelegramLink(webLink); else window.open(webLink,'_blank');
    });

    // ====== –ú–û–î–ê–õ–ö–ê –í–´–í–û–î–ê ======
    const wdModal = document.getElementById('wdModal');
    const openBtn = document.getElementById('withdrawOpen');
    const closeBtns = [document.getElementById('wdClose'), document.getElementById('wdCancel')];
    const addrInp = document.getElementById('wdAddr');
    const amtInp  = document.getElementById('wdAmount');
    const errBox  = document.getElementById('wdErr');
    const fillAll = document.getElementById('fillAll');
    const form    = document.getElementById('wdForm');
    const sendBtn = document.getElementById('wdSend');

    function updateSubmitState(){
  const minor = toMinor(amtInp.value);
  const enough = minor !== null && minor >= MIN_WITHDRAW_MINOR && minor <= balanceMinor;
  sendBtn.disabled = !enough;
}

// –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã –∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
amtInp.addEventListener('input', updateSubmitState);

    function openModal(m){ m.classList.add('is-open'); m.setAttribute('aria-hidden','false'); }
    function closeModal(m){ m.classList.remove('is-open'); m.setAttribute('aria-hidden','true'); }

    function openWd(){
      openModal(wdModal);
      errBox.textContent=''; amtInp.value=''; addrInp.value=''; addrInp.focus();
      updateSubmitState(); // –ù–û–í–û–ï
    }

    openBtn.addEventListener('click', openWd);
    closeBtns.forEach(b=>b.addEventListener('click', ()=>closeModal(wdModal)));
    wdModal.addEventListener('click', (e)=>{ if (e.target===wdModal) closeModal(wdModal); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && wdModal.classList.contains('is-open')) closeModal(wdModal); });

    fillAll.addEventListener('click', ()=>{
      amtInp.value = (balanceMinor/100).toFixed(2).replace('.', ',');
      // –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ ¬´–º–∏–Ω–∏–º–∞–ª–∫–∏¬ª ‚Äì —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂–µ–º –ø—Ä–∏—á–∏–Ω—É
      errBox.textContent = (balanceMinor < MIN_WITHDRAW_MINOR) ? '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 5 000 ‚ÇΩ' : '';
      updateSubmitState(); // –ù–û–í–û–ï
      amtInp.focus();
    });


    function isTonAddress(s){ const x=String(s||'').trim(); return /^(UQ|EQ|kQ|0:)/i.test(x) && x.length>=20; 
    }

    function validateWd(){
      errBox.textContent='';
      const minor = toMinor(amtInp.value);
      if (minor===null){ errBox.textContent='–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'; return null; }
      if (minor<=0){ errBox.textContent='–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0'; return null; }

      // –ù–û–í–û–ï: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
      if (minor < MIN_WITHDRAW_MINOR){
        errBox.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 5 000 ‚ÇΩ';
        return null;
      }

      if (minor>balanceMinor){ errBox.textContent='–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'; return null; }
      if (!isTonAddress(addrInp.value)){ errBox.textContent='–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TON-–∞–¥—Ä–µ—Å'; return null; }
      return minor;
    }

    form.addEventListener('submit', async ()=>{
      const minor = validateWd(); if (minor===null) return;
      const addr = addrInp.value.trim();
      sendBtn.disabled = true;
      try{
        const r = await fetch(`${API_BASE}/ref/withdraw`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ tg_user_id: MY_ID, amount_minor: minor, ton_address: addr })
        });
        if (!r.ok){
          const err = await r.json().catch(()=>({detail:'–û—à–∏–±–∫–∞'}));
          errBox.textContent = err.detail || '–û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞'; return;
        }
        const data = await r.json();
        balanceMinor = Number(data.balance_minor||0);
        document.getElementById('balanceValue').textContent = rubFmt(balanceMinor);

        const who = MY_USERNAME ? ('@'+MY_USERNAME) : ('id'+MY_ID);
        const msg = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –≤—ã–≤–æ–¥\n–ê–¥—Ä–µ—Å: ${addr}\n–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞: ${(minor/100).toFixed(2)} ‚ÇΩ\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${who}\n–ó–∞—è–≤–∫–∞: ${data.payout_id}`;
        const supportLink = `https://t.me/${encodeURIComponent('${SUPPORT_USERNAME}'.replace(/[{}$]/g,''))}?text=${encodeURIComponent(msg)}`;
        if (tg?.openTelegramLink) tg.openTelegramLink(supportLink); else window.open(supportLink,'_blank');

        tg?.showToast?.('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞');
        closeModal(wdModal);
      }catch(e){
        errBox.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
      } finally {
        sendBtn.disabled = false;
      }
    });

    // ====== –ú–û–î–ê–õ–ö–ê –°–¢–ê–í–û–ö ======
    const ratesModal = document.getElementById('ratesModal');
    const ratesOpen = document.getElementById('ratesOpen');
    const ratesClose = document.getElementById('ratesClose');
    const ratesGrid = document.getElementById('ratesGrid');

    function productList(){
      return [
        {key:'stars',   title:'–ó–≤—ë–∑–¥—ã'},
        {key:'gifts',   title:'–ü–æ–¥–∞—Ä–∫–∏'},
        {key:'ton',     title:'TON'},
        {key:'premium', title:'Premium'},
        {key:'steam',   title:'Steam'},
      ];
    }

    async function loadRates(){
      // –ø—ã—Ç–∞–µ–º—Å—è /ref/rates, –∑–∞—Ç–µ–º /ref/config; –∏–Ω–∞—á–µ ‚Äî –∑–∞–≥–ª—É—à–∫–∏
      let data = null;
      try{
        const r = await fetch(`${API_BASE}/ref/rates`);
        if (r.ok) data = await r.json();
      }catch(e){}
      if (!data){
        try{
          const r2 = await fetch(`${API_BASE}/ref/config`);
          if (r2.ok) data = await r2.json();
        }catch(e){}
      }
      // –æ–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—ã: {items:[{product,percent}]} –ò–õ–ò {rates:{product:percent}}
      const map = {};
      if (data?.items?.length){
        data.items.forEach(it=>{ map[it.product]=it.percent; });
      } else if (data?.rates){
        Object.assign(map, data.rates);
      }
      // —Ä–∏—Å—É–µ–º 5 –∫–∞—Ä—Ç–æ—á–µ–∫
      ratesGrid.innerHTML = '';
      productList().forEach(p=>{
        const val = map[p.key];
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `<p class="stat-title">${p.title}</p><p class="stat-value">${val==null?'‚Äî':pctFmt(val)}</p>`;
        ratesGrid.appendChild(card);
      });
    }

    ratesOpen.addEventListener('click', async ()=>{
      await loadRates();
      openModal(ratesModal);
    });
    ratesClose.addEventListener('click', ()=>closeModal(ratesModal));
    ratesModal.addEventListener('click', (e)=>{ if (e.target===ratesModal) closeModal(ratesModal); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && ratesModal.classList.contains('is-open')) closeModal(ratesModal); });

    // ====== –°–¢–ê–†–¢ ======
    init();
  })();
  </script>
</body>
</html>

